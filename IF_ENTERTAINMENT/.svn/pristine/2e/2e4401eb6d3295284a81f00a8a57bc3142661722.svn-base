<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<link rel="stylesheet" href="${pageContext.request.contextPath }/resources/css1/bootstrap.min.css">
<link rel="stylesheet" href="${pageContext.request.contextPath }/resources/css1/animate.min.css">
<script src="${pageContext.request.contextPath }/resources/js1/jquery.js"></script> 
<script src="${pageContext.request.contextPath }/resources/js1/bootstrap.min.js"></script> 
<%-- <script src="${pageContext.request.contextPath }/resources/js1/nice-select.js"></script>  --%>
<%-- <script src="${pageContext.request.contextPath }/resources/js1/custom2.js"></script>  --%>
<script src="${pageContext.request.contextPath }/resources/js1/custom.js"></script>
<style>
.quick-all-report{
	min-height: 100px;
	padding-left: 80px;
    left: 246px;
    top: 78px;
    z-index: 10;
    position: fixed;
    background: white;
    width: 1675px;
}

.btn2{
	width: 100px;
	font-size: large;
	font-weight: bold;
}

.adjust {
	display: flex;
	flex-direction: row;
	justify-content: space-between;
}

.slc {
	position: relative;
	right: 100px;
	z-index: 10;
}

.nice-select{
	min-width: 300px;
	height: 43px;
}

.quick-all-report .duration .btn2 {
    transition: background-color 0.5s ease; 
}

.quick-all-report .duration .btn2:active,
.quick-all-report .duration .btn2:focus {
    background-image: linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%);
}

#container_register {
    width: 1525px;
    height: 600px;
    overflow: hidden;
}

#container_keyword_male, 
#container_keyword_female {
	min-height: 410px;
	max-height: 410px;
}
.widget-body, .widget-all {
	height: 410px;
}
 
/* .keyChart { */
/*     position: relative; */
/*     top: -150px; */
/*     width: 100%; */
/*     float: none; */
/* } */

.kewordsChart {
	max-height: 410px;
}

.highcharts-credits {
    display: none !important;
}

#container_artistSales, #container_topSales {
    width: 1525px;
    height: 600px;
    overflow: hidden;
}

</style>

<div class="widget">
	<div class="quick-all-report">
		<div class="row adjust">
			<div class="duration">
				<a href="#" data-dur="all" class="btn2 brd-5 twitter-clr">전체기간</a>			
				<a href="#" data-dur="7DAY" class="btn2 brd-5 twitter-clr">1주일</a>			
				<a href="#" data-dur="1MONTH" class="btn2 brd-5 twitter-clr">1개월</a>			
				<a href="#" data-dur="3MONTH" class="btn2 brd-5 twitter-clr">3개월</a>			
				<a href="#" data-dur="6MONTH" class="btn2 brd-5 twitter-clr">6개월</a>			
				<a href="#" data-dur="1YEAR" class="btn2 brd-5 twitter-clr">12개월</a>			
			</div>

			<div class="slc">
				<select id="agList" style="behavior: url('/inc/selectBox.htc');">
					<option value="">아티스트를 선택하세요</option>
					<c:forEach items="${agIdList }" var="agId">
						<option value="${agId }">${agId }</option>
					</c:forEach>
				</select>
			</div>
		</div>
	</div>
</div>

<!-- 기간별 가입자 분석 -->
<div class="widget register-chart">
	<div class="widget-title">
		<h4 class="sub-title">굿즈 판매 통계</h4>
	</div>
	<div class="widget-peding">
		<div class="revenue-chart">
			<!-- 그래프 추가 영역 -->
			<div id="container_artistSales"></div>
		</div>
	</div>
</div>
<!-- 기간별 가입자 분석 끝 -->

<!-- 기간별 가입자 분석 -->
<div class="widget register-chart">
	<div class="widget-title">
		<h4 class="sub-title">굿즈 판매 통계</h4>
	</div>
	<div class="widget-peding">
		<div class="revenue-chart">
			<!-- 그래프 추가 영역 -->
			<div id="container_topSales"></div>
		</div>
	</div>
</div>
<!-- 기간별 가입자 분석 끝 -->

<!-- 가입자 파이차트 -->
<div class="col-lg-12">
	<div class="row">
		<!--  -->
		<div class="col-lg-6">
			<div class="widget widget-all">
				<div class="widget-title no-margin">
					<h4 class="sub-title">가입 성별</h4>
				</div>
				<div class="widget widget-body">
					<div class="revenue-chart line">
						<!-- 그래프 추가 영역 -->
						<div id="container_gender"></div>
					</div>
				</div>
			</div>
		</div>

		<!--  -->
		<div class="col-lg-6">
			<div class="widget widget-all">
				<div class="widget-title no-margin">
					<h4 class="sub-title">가입 연령</h4>
				</div>
				<div class="widget widget-body">
					<div class="revenue-chart line">
						<!-- 그래프 추가 영역 -->
						<div id="container_age"></div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
<script src="https://code.highcharts.com/modules/drilldown.js"></script>
<script>
$(function(){
	
	var artistAmounts = [];		// 아티스트별 매출금액을 담을 배열 선언 [artist, price]
	var artistAmountsArr = [];	// 아티스트별 매출금액을 담을 배열을 담을 배열 선언 [[artist1, price1], [artist2, price2]...]
	
    var duration = "";			// ajax 통신시 전송할 기간 변수선언
    var agId = "";				// ajax 통신시 전송할 아티스트 변수선언
    
	var durationText = "전체기간"; 		     // 차트 제목에 표기될 기간
	var artistText = "[ ALL ARTIST ]";	     // 차트 제목에 표기될 아티스트명
	
	$(".highcharts-credits").hide();
	
	var token = $("meta[name='_csrf']").attr("content");
	var header = $("meta[name='_csrf_header']").attr("content");
	
	 var agIdSelectBox = $('#agList');
	 agIdSelectBox.niceSelect(); // nice-select 플러그인을 초기화
	
	 // 리스트가 너무 길어져 스크롤 기능을 추가
    $('#agList').parent().find('.list').css({
        'max-height': '200px', // 드롭다운 리스트의 최대 높이 설정
        'overflow-y': 'auto' // 스크롤이 필요할 경우 스크롤 추가
    });
	 
    // 페이지 로드 시 기본 데이터 로드
    $.ajax({
        url: "/admin/statistics/goodsAjax.do",
        type: "get",
        beforeSend: function(xhr){
            xhr.setRequestHeader(header, token);
        },
        success: function(defaultData){
            // 그래프 생성
            createChart(defaultData);
        }, 
        error: function(xhr, status, error) {
            // 오류가 발생한 경우 실행할 코드
            console.error("AJAX 오류: ", status, error);
        }
    });
    
    // 아티스트 셀렉트박스를 선택할 때 데이터 로드
    agIdSelectBox.on("change", function(event){
    	event.preventDefault();
        
        if($(this).val() != ""){
	        artistText = "[ " + $(this).val() + " ]";
        } else  {
        	artistText = "[ ALL ARTIST ]";
        }
        
        agId = $(this).val();
        loadData(duration, agId);
    });
    
    // 기간 선택 시 데이터 로드
    $(".brd-5").on("click", function(event){
        event.preventDefault();
        
        duration = $(this).data("dur");
        
        // 기존 차트 초기화
        $('#container_artistSales').empty();
        
        loadData(duration, agId);
        
        switch(duration) {
        case '7DAY':  
        	durationText = "최근 1주일";
        	break;
        case '1MONTH': 
        	durationText = "최근 1개월";
        	break;
        case '3MONTH': 
        	durationText = "최근 3개월";
        	break;
        case '6MONTH': 
        	durationText = "최근 6개월";
        	break;
        case '1YEAR': 
        	durationText = "최근 12개월";
        	break;
        default :
        	durationText = "전체기간";
        }
    });
	// 그래프 생성 함수
    function createChart(data) {
		
		/* 아티스트별, 기간별 판매 금액이 담겨 있는 리스트 */
		var artistSales = data.artistSalesList;
		
		artistAmounts = [];		
		artistAmountsArr = [];
		
		console.log("## data : ", data.artistSalesList);
		for (var i = 0; i < artistSales.length; i++) {
			artistAmounts = []
			artistAmounts.push(artistSales[i].goodsArtist);
			artistAmounts.push(artistSales[i].totalPrice);
			artistAmountsArr.push(artistAmounts);
		}
		console.log("이 데이터 넘기면 안대?", artistAmountsArr);
		
		// 아티스트별 기간 별 굿즈샵 매출액
    	Highcharts.chart('container_artistSales', {
    	    chart: {
    	        type: 'column'
    	    },
    	    title: {
    	        text: durationText + ' 아티스트별 판매내역'
    	    },
    	    subtitle: {
    	        text: '단위 : 원',
    	        align: 'right'
    	    },
    	    xAxis: {
    	        type: 'category',
    	        labels: {
    	            autoRotation: [-45, -90],
    	            style: {
    	                fontSize: '13px',
    	                fontFamily: 'Verdana, sans-serif'
    	            }
    	        }
    	    },
    	    yAxis: {
    	        min: 0,
    	        title: {
//     	            text: 'Population (millions)'
    	            text: ''
    	        }
    	    },
    	    legend: {
    	        enabled: false
    	    },
    	    tooltip: {
    	        formatter: function() {
    	            return '<b>' + this.point.name + '</b><br/>판매액: ' + Highcharts.numberFormat(this.point.y, 0, '', ',') + '원'; // #,### 포맷팅 적용
    	        }
    	    },
    	    series: [{
    	        name: 'Population',
    	        colors: [
    	            '#9b20d9', '#9215ac', '#861ec9', '#7a17e6', '#7010f9', '#691af3',
    	            '#6225ed', '#5b30e7', '#533be1', '#4c46db', '#4551d5', '#3e5ccf',
    	            '#3667c9', '#2f72c3', '#277dbd', '#1f88b7', '#1693b1', '#0a9eaa',
    	            '#03c69b',  '#00f194'
    	        ],
    	        colorByPoint: true,
    	        groupPadding: 0,
    	        data: artistAmountsArr,
    	        dataLabels: {
    	            enabled: true,
    	            rotation: -90,
    	            color: '#FFFFFF',
    	            inside: true,
    	            verticalAlign: 'top',
    	            format: '{point.name}', // 아티스트 이름 표시
    	            y: 10, // 10 pixels down from the top
    	            style: {
    	                fontSize: '13px',
    	                fontFamily: 'Verdana, sans-serif'
    	            }
    	        }
    	    }]
    	});
		/* 아티스트별 기간 별 굿즈샵 매출액 끝 */
		
		/* 탑 세일즈 통계 시작 */
		Highcharts.chart('container_topSales', {
		    chart: {
		        type: 'column'
		    },
		    title: {
		        align: 'center',
		        text: durationText + ' 판매 TOP 5 아티스트'
		    },
		    subtitle: {
		        align: 'right',
		        text: '단위 : 원'
		    },
		    accessibility: {
		        announceNewData: {
		            enabled: true
		        }
		    },
		    xAxis: {
		        type: 'category'
		    },
		    yAxis: {
		        title: {
		            text: 'Total percent market share'
		        }
		
		    },
		    legend: {
		        enabled: false
		    },
		    plotOptions: {
		        series: {
		            borderWidth: 0,
		            dataLabels: {
		                enabled: true,
		                format: '{point.y:.1f}%'
		            }
		        }
		    },
		
		    tooltip: {
		        headerFormat: '<span style="font-size:11px">{series.name}</span><br>',
		        pointFormat: '<span style="color:{point.color}">{point.name}</span>: <b>{point.y:.2f}%</b> of total<br/>'
		    },
		
		    series: [
		        {
		            name: 'Browsers',
		            colorByPoint: true,
		            data: [
		                {
		                    name: 'Chrome',
		                    y: 63.06,
		                    drilldown: 'Chrome'
		                },
		                {
		                    name: 'Safari',
		                    y: 19.84,
		                    drilldown: 'Safari'
		                },
		                {
		                    name: 'Firefox',
		                    y: 4.18,
		                    drilldown: 'Firefox'
		                },
		                {
		                    name: 'Edge',
		                    y: 4.12,
		                    drilldown: 'Edge'
		                },
		                {
		                    name: 'Opera',
		                    y: 2.33,
		                    drilldown: 'Opera'
		                },
		                {
		                    name: 'Other',
		                    y: 1.582,
		                    drilldown: null
		                }
		            ]
		        }
		    ],
		    drilldown: {
		        breadcrumbs: {
		            position: {
		                align: 'right'
		            }
		        },
		        series: [
		            {
		                name: 'Chrome',
		                id: 'Chrome',
		                data: [
		                    [
		                        'v65.0',
		                        0.1
		                    ],
		                    [
		                        'v64.0',
		                        1.3
		                    ],
		                    [
		                        'v63.0',
		                        53.02
		                    ],
		                    [
		                        'v62.0',
		                        1.4
		                    ],
		                    [
		                        'v61.0',
		                        0.88
		                    ],
		                    [
		                        'v60.0',
		                        0.56
		                    ],
		                    [
		                        'v59.0',
		                        0.45
		                    ],
		                    [
		                        'v58.0',
		                        0.49
		                    ],
		                    [
		                        'v57.0',
		                        0.32
		                    ],
		                    [
		                        'v56.0',
		                        0.29
		                    ],
		                    [
		                        'v55.0',
		                        0.79
		                    ],
		                    [
		                        'v54.0',
		                        0.18
		                    ],
		                    [
		                        'v51.0',
		                        0.13
		                    ],
		                    [
		                        'v49.0',
		                        2.16
		                    ],
		                    [
		                        'v48.0',
		                        0.13
		                    ],
		                    [
		                        'v47.0',
		                        0.11
		                    ],
		                    [
		                        'v43.0',
		                        0.17
		                    ],
		                    [
		                        'v29.0',
		                        0.26
		                    ]
		                ]
		            },
		            {
		                name: 'Firefox',
		                id: 'Firefox',
		                data: [
		                    [
		                        'v58.0',
		                        1.02
		                    ],
		                    [
		                        'v57.0',
		                        7.36
		                    ],
		                    [
		                        'v56.0',
		                        0.35
		                    ],
		                    [
		                        'v55.0',
		                        0.11
		                    ],
		                    [
		                        'v54.0',
		                        0.1
		                    ],
		                    [
		                        'v52.0',
		                        0.95
		                    ],
		                    [
		                        'v51.0',
		                        0.15
		                    ],
		                    [
		                        'v50.0',
		                        0.1
		                    ],
		                    [
		                        'v48.0',
		                        0.31
		                    ],
		                    [
		                        'v47.0',
		                        0.12
		                    ]
		                ]
		            },
		            {
		                name: 'Safari',
		                id: 'Safari',
		                data: [
		                    [
		                        'v11.0',
		                        3.39
		                    ],
		                    [
		                        'v10.1',
		                        0.96
		                    ],
		                    [
		                        'v10.0',
		                        0.36
		                    ],
		                    [
		                        'v9.1',
		                        0.54
		                    ],
		                    [
		                        'v9.0',
		                        0.13
		                    ],
		                    [
		                        'v5.1',
		                        0.2
		                    ]
		                ]
		            },
		            {
		                name: 'Edge',
		                id: 'Edge',
		                data: [
		                    [
		                        'v16',
		                        2.6
		                    ],
		                    [
		                        'v15',
		                        0.92
		                    ],
		                    [
		                        'v14',
		                        0.4
		                    ],
		                    [
		                        'v13',
		                        0.1
		                    ]
		                ]
		            },
		            {
		                name: 'Opera',
		                id: 'Opera',
		                data: [
		                    [
		                        'v50.0',
		                        0.96
		                    ],
		                    [
		                        'v49.0',
		                        0.82
		                    ],
		                    [
		                        'v12.1',
		                        0.14
		                    ]
		                ]
		            }
		        ]
		    }
		});
		/* 탑 세일즈 통계 끝 */

	}
	
    // 데이터 로드 함수
    function loadData(duration, agId) {
        $.ajax({
            url: "/admin/statistics/goodsAjax.do?duration=" + duration + "&agId=" + agId,
            type: "get",
            beforeSend: function(xhr){
                xhr.setRequestHeader(header, token);
            },
            success: function(data){
                // 그래프 생성
                createChart(data);
            },
            error: function(xhr, status, error) {
	            console.error("데이터 로드 AJAX 오류: ", status, error);
	        }
        });
    }
	 
	 
});

</script>